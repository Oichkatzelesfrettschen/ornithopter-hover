name: Build, Test, and Verify

on:
  push:
    branches: [ main, develop, 'copilot/**' ]
  pull_request:
    branches: [ main, develop ]

jobs:
  build:
    name: Build Firmware
    runs-on: ubuntu-latest
    strategy:
      matrix:
        environment: [arduino_nano, teensy40, esp32]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Cache PlatformIO
        uses: actions/cache@v3
        with:
          path: |
            ~/.platformio
            .pio
          key: ${{ runner.os }}-pio-${{ hashFiles('**/platformio.ini') }}
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install PlatformIO
        run: |
          pip install platformio
      
      - name: Build firmware for ${{ matrix.environment }}
        run: |
          platformio run -e ${{ matrix.environment }}
      
      - name: Upload firmware artifacts
        uses: actions/upload-artifact@v3
        with:
          name: firmware-${{ matrix.environment }}
          path: .pio/build/${{ matrix.environment }}/firmware.*
  
  test:
    name: Run Unit Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install PlatformIO
        run: |
          pip install platformio
      
      - name: Run native tests
        run: |
          platformio test -e native
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: test-results
          path: .pio/test/
  
  formal-verification:
    name: Formal Verification
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install Z3
        run: |
          pip install z3-solver
      
      - name: Run Z3 verification
        run: |
          python verification/verify_all.py
      
      - name: Set up Java (for TLA+)
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '11'
      
      - name: Download TLA+ Tools
        run: |
          mkdir -p tools
          cd tools
          wget -q https://github.com/tlaplus/tlaplus/releases/download/v1.7.1/tla2tools.jar
      
      - name: Run TLA+ Model Checking
        run: |
          cd specs
          java -jar ../tools/tla2tools.jar -workers auto OrnithopterController.tla
          echo "TLA+ verification completed"
      
      - name: Check TLA+ results
        run: |
          cd specs
          if [ -f OrnithopterController.out ]; then
            cat OrnithopterController.out
            if grep -q "Error" OrnithopterController.out; then
              echo "TLA+ verification found errors!"
              exit 1
            fi
          fi
      
      - name: Upload verification results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: verification-results
          path: |
            specs/*.out
            verification/*.log
  
  documentation:
    name: Build Documentation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install documentation tools
        run: |
          pip install mkdocs mkdocs-material
      
      - name: Check documentation links
        run: |
          # Verify all markdown files are valid
          find docs -name "*.md" -type f -print0 | xargs -0 -I {} sh -c 'echo "Checking: {}"; grep -q "^# " {}'
      
      - name: Upload documentation
        uses: actions/upload-artifact@v3
        with:
          name: documentation
          path: docs/
  
  summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [build, test, formal-verification, documentation]
    if: always()
    
    steps:
      - name: Summary
        run: |
          echo "## Build and Verification Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ Build completed for all targets" >> $GITHUB_STEP_SUMMARY
          echo "✅ Unit tests executed" >> $GITHUB_STEP_SUMMARY
          echo "✅ Formal verification completed" >> $GITHUB_STEP_SUMMARY
          echo "✅ Documentation validated" >> $GITHUB_STEP_SUMMARY
